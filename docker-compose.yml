services:
  # ===== MONITORING STACK =====
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9191:9090"
    volumes:
      - ./docker-monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - monitoring-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - monitoring-network
    restart: unless-stopped

  # --- ADIÇÃO: LOKI (Log Storage) ---
  loki:
    image: grafana/loki:2.9.2
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - monitoring-network
    restart: unless-stopped

  # --- ADIÇÃO: PROMTAIL (Log Collector) ---
  promtail:
    image: grafana/promtail:2.9.2
    container_name: promtail
    volumes:
      - ./docker-monitoring/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring-network
    restart: unless-stopped

  # ===== GRPC MICROSERVICES =====
  # Módulo A - Microserviço gRPC (Node.js)
  modulo-a:
    build:
      context: .
      dockerfile: modulo_A/Dockerfile
    container_name: modulo-a-grpc
    ports:
      - "50051:50051"
      - "5001:5001"
    networks:
      - grpc-network
    # Labels para o Promtail identificar melhor este serviço (opcional, mas recomendado)
    labels:
      logging: "promtail"
      service: "modulo-a"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Módulo B - Microserviço gRPC (Node.js)
  modulo-b:
    build:
      context: .
      dockerfile: modulo_B/Dockerfile
    container_name: modulo-b-grpc
    ports:
      - "50052:50052"
      - "5002:5002"
    networks:
      - grpc-network
    labels:
      logging: "promtail"
      service: "modulo-b"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50052"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Módulo P - Gateway/Proxy (Python FastAPI)
  modulo-p:
    build:
      context: .
      dockerfile: modulo_P/Dockerfile
    container_name: modulo-p-chat-gateway
    ports:
      - "8000:8000"
    environment:
      - MODULO_A_HOST=modulo-a
      - MODULO_A_PORT=50051
      - MODULO_B_HOST=modulo-b
      - MODULO_B_PORT=50052
    networks:
      - grpc-network
    depends_on:
      - modulo-a
      - modulo-b
    labels:
      logging: "promtail"
      service: "modulo-p"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Frontend com Chat HTML
  chat-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: chat-frontend
    ports:
      - "3000:3000"
    networks:
      - grpc-network
    depends_on:
      - modulo-p
    labels:
      logging: "promtail"
      service: "frontend"
    restart: unless-stopped

networks:
  monitoring-network:
    driver: bridge
  grpc-network:
    driver: bridge
    name: projeto-distribuido-network

volumes:
  prometheus-data:
  grafana-storage:
  logs:
    driver: local
